jstestdriver.Heartbeat=function(d,c,h,b,e,g,f,i,a){this.id_=d;this.url_=c;this.capturePath_=h;this.retries_=0;this.sendRequest_=b;this.interval_=e;this.boundHeartbeatCallback_=jstestdriver.bind(this,this.heartbeatCallback);this.boundSendHeartBeat_=jstestdriver.bind(this,this.sendHeartbeat);this.boundErrorCallback_=jstestdriver.bind(this,this.errorCallback);this.sent_=0;this.timeoutId_=-1;this.setTimeout_=g;this.getTime_=f;this.view_=i;this.navigateToPath_=a};jstestdriver.Heartbeat.RETRY_LIMIT=50;jstestdriver.Heartbeat.prototype.start=function(){this.view_.updateConnected(true);this.sendHeartbeat()};jstestdriver.Heartbeat.prototype.stop=function(){jstestdriver.clearTimeout(this.timeoutId_);this.view_.updateStatus("Dead.")};jstestdriver.Heartbeat.prototype.sendHeartbeat=function(){this.sent_=this.getTime_();this.view_.updateLastBeat(this.sent_);this.sendRequest_(this.url_,{id:this.id_},this.boundHeartbeatCallback_,this.boundErrorCallback_)};jstestdriver.Heartbeat.prototype.errorCallback=function(){this.view_.updateConnected(false);if(this.retries_>jstestdriver.Heartbeat.RETRY_LIMIT){this.stop();return}this.retries_++;this.view_.updateStatus("Retrying "+this.retries_+" out of "+jstestdriver.Heartbeat.RETRY_LIMIT);this.timeoutId_=this.setTimeout_(this.boundSendHeartBeat_,this.interval_)};jstestdriver.Heartbeat.prototype.heartbeatCallback=function(c){if(c=="UNKNOWN"){this.navigateToPath_(this.capturePath_);return}var a=this.getTime_()-this.sent_;this.sent_=0;this.view_.updateStatus(c);if(a<this.interval_){var b=this.interval_-(a>0?a:0);this.view_.updateNextBeat(b);this.timeoutId_=this.setTimeout_(this.boundSendHeartBeat_,b)}else{this.sendHeartbeat()}};jstestdriver.HeartbeatView=function(a,b){this.getBody_=a;this.createElement_=b;this.root_=null;this.status_=null;this.lastBeat_=null;this.nextBeat_=null};jstestdriver.HeartbeatView.prototype.ensureView=function(){if(!this.root_){var b=this.getBody_();var a=b.ownerDocument;this.root_=b.appendChild(a.createElement("p"));this.root_.innerHTML="JsTestDriver<br/>";this.lastBeat_=this.root_.appendChild(a.createElement("span"));this.root_.appendChild(a.createTextNode(" | "));this.nextBeat_=this.root_.appendChild(a.createElement("span"));this.root_.appendChild(a.createTextNode(" | "));this.status_=this.root_.appendChild(a.createElement("span"))}};jstestdriver.HeartbeatView.prototype.updateLastBeat=function(a){this.ensureView();this.lastBeat_.innerHTML=" Last:"+a};jstestdriver.HeartbeatView.prototype.updateNextBeat=function(a){this.ensureView();this.nextBeat_.innerHTML=" Next:"+a};jstestdriver.HeartbeatView.prototype.updateStatus=function(a){this.ensureView();this.status_.innerHTML=" Server:"+a};jstestdriver.HeartbeatView.prototype.updateConnected=function(a){if(!a){this.getBody_().className=jstestdriver.HeartbeatView.ERROR_CLASS;this.updateStatus("Lost server...")}else{this.getBody_().className="";this.updateStatus("Waiting...")}};jstestdriver.HeartbeatView.ERROR_CLASS="error";