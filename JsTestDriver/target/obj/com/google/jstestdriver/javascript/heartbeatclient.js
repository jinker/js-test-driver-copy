goog.provide("jstestdriver.utils");jstestdriver.convertToJson=function(b){var a=jstestdriver.parameterSerialize;return function(c,e,f,d){b(c,a(e),f,d)}};jstestdriver.parameterSerialize=function(c){var b={};for(var a in c){b[a]=JSON.stringify(c[a])}return b};jstestdriver.bind=function(a,c){function b(){return c.apply(a,arguments)}b.toString=function(){return"bound: "+a+" to: "+c};return b};jstestdriver.extractId=function(a){return a.match(/\/id\/(\d+)\//)[1]};jstestdriver.createPath=function(c,b){var a=c.match(/^(.*)\/(slave|runner|bcr)\//)[1];return a+b};jstestdriver.getBrowserFriendlyName=function(){if(jstestdriver.jQuery.browser.safari){if(navigator.userAgent.indexOf("Chrome")!=-1){return"Chrome"}return"Safari"}else{if(jstestdriver.jQuery.browser.opera){return"Opera"}else{if(jstestdriver.jQuery.browser.msie){return"Internet Explorer"}else{if(jstestdriver.jQuery.browser.mozilla){if(navigator.userAgent.indexOf("Firefox")!=-1){return"Firefox"}return"Mozilla"}}}}};jstestdriver.getBrowserFriendlyVersion=function(){if(jstestdriver.jQuery.browser.msie){if(typeof XDomainRequest!="undefined"){return"8.0"}}else{if(jstestdriver.jQuery.browser.safari){if(navigator.appVersion.indexOf("Chrome/")!=-1){return navigator.appVersion.match(/Chrome\/(.*)\s/)[1]}}}return jstestdriver.jQuery.browser.version};jstestdriver.trim=function(a){return a.replace(/(^\s*)|(\s*$)/g,"")};jstestdriver.toHtml=function(c,e){var b=e.createDocumentFragment();var d=e.createElement("div");d.innerHTML=jstestdriver.trim(jstestdriver.stripHtmlComments(c));while(d.firstChild){b.appendChild(d.firstChild)}var a=b.childNodes.length>1?b:b.firstChild;return a};jstestdriver.stripHtmlComments=function(b){var d=[];function a(h){var i=b.indexOf("<!--",h);var g=b.indexOf("-->",h)+"-->".length;if(i==-1){return null}return{"start":i,"stop":g}}var c=0;while(true){var f=a(c);if(!f){d.push(b.slice(c));break}var e=b.slice(c,f.start);d.push(e);c=f.stop}return d.join("")};jstestdriver.appendHtml=function(b,c){var a=jstestdriver.toHtml(b,c);jstestdriver.jQuery(c.body).append(a)};jstestdriver.now=function(){return new Date().getTime()};jstestdriver.createSynchPost=function(a){return jstestdriver.convertToJson(function(b,c){return a.ajax({"async":false,"data":c,"type":"POST","url":b,"contentType":"application/x-www-form-urlencoded; charset=GB2312"})})};jstestdriver.createAsynchPost=function(a){return jstestdriver.convertToJson(function(b,d,e,c){return a.ajax({"data":d,"type":"POST","url":b,"success":e,"dataType":c,"contentType":"application/x-www-form-urlencoded; charset=GB2312"})})};jstestdriver.utils={};jstestdriver.utils.isNative=function(a,d){try{var b=String(Object.prototype.toString.apply(a));return b.toLowerCase().indexOf(d.toLowerCase())!=-1}catch(c){return false}};jstestdriver.utils.serializeErrors=function(c){var a=[];a.push("[");for(var b=0;b<c.length;++b){jstestdriver.utils.serializeErrorToArray(c[b],a);if(b<c.length-1){a.push(",")}}a.push("]");return a.join("")};jstestdriver.utils.serializeErrorToArray=function(b,a){if(jstestdriver.utils.isNative(b,"Error")){a.push("{");a.push('"message":');jstestdriver.utils.serializeObjectToArray(b.message,a);jstestdriver.utils.serializePropertyOnObject("name",b,a);jstestdriver.utils.serializePropertyOnObject("description",b,a);jstestdriver.utils.serializePropertyOnObject("fileName",b,a);jstestdriver.utils.serializePropertyOnObject("lineNumber",b,a);jstestdriver.utils.serializePropertyOnObject("number",b,a);jstestdriver.utils.serializePropertyOnObject("stack",b,a);a.push("}")}else{a.push(jstestdriver.utils.serializeObject(b))}};jstestdriver.utils.serializeObject=function(b){var a=[];jstestdriver.utils.serializeObjectToArray(b,a);return a.join("")};jstestdriver.utils.serializeObjectToArray=function(e,b){var c=b||c;if(jstestdriver.utils.isNative(e,"Array")){c.push("[");var a=(e);for(var d=0;d<a.length;d++){this.serializeObjectToArray(a[d],c);if(d<a.length-1){c.push(",")}}c.push("]")}else{jstestdriver.utils.toJsonArray(c,e,false,[])}return c};jstestdriver.utils.serializePropertyOnObject=function(b,c,a){if(b in c){a.push(",");a.push('"'+b+'":');this.serializeObjectToArray(c[b],a)}};jstestdriver.utils.quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v")+'"'};jstestdriver.utils.quoteUnicode=function(a){var f=jstestdriver.utils.quote(a);var e=[];for(var b=0;b<f.length;b++){var c=f.charCodeAt(b);if(c<128){e.push(f.charAt(b))}else{var d="000"+c.toString(16);e.push("\\u"+d.substring(d.length-4))}}return e.join("")};jstestdriver.utils.includes=function(b,c){for(var a=0;a<b.length;a++){if(b[a]===c){return true}}return false};jstestdriver.utils.toJsonArray=function(b,d,g,h){if(jstestdriver.utils.isNative(d,"object")){if(d===window){b.push(jstestdriver.utils.quote("WINDOW"));return}if(d===document){b.push(jstestdriver.utils.quote("DOCUMENT"));return}if(jstestdriver.utils.includes(h,d)){b.push(jstestdriver.utils.quote("RECURSION"));return}h.push(d)}if(d===null){b.push("null")}else{if(d instanceof RegExp){b.push(jstestdriver.utils.quoteUnicode(d.toString()))}else{if(jstestdriver.utils.isNative(d,"function")){return}else{if(jstestdriver.utils.isNative(d,"boolean")){b.push(""+d)}else{if(jstestdriver.utils.isNative(d,"number")){if(isNaN(d)){b.push("null")}else{b.push(""+d)}}else{if(jstestdriver.utils.isNative(d,"string")){return b.push(jstestdriver.utils.quoteUnicode(d))}else{if(jstestdriver.utils.isNative(d,"object")){if(jstestdriver.utils.isNative(d,"array")){b.push("[");var f=d.length;var q=false;for(var e=0;e<f;e++){var n=d[e];if(q){b.push(",")}if(!(n instanceof RegExp)&&(jstestdriver.utils.isNative(n,"function")||jstestdriver.utils.isNative(n,"undefined"))){b.push("null")}else{jstestdriver.utils.toJsonArray(b,n,g,h)}q=true}b.push("]")}else{if(jstestdriver.utils.isNative(d,"date")){b.push(jstestdriver.utils.quoteUnicode(d.toString()))}else{b.push("{");if(g){b.push(g)}var p=false;var o=g?g+"  ":false;var m=[];for(var c in d){if(d[c]===undefined){continue}m.push(c)}m.sort();for(var a=0;a<m.length;a++){var l=m[a];var j=d[l];if(typeof j!="function"){if(p){b.push(",");if(g){b.push(g)}}b.push(jstestdriver.utils.quote(l));b.push(":");jstestdriver.utils.toJsonArray(b,j,o,h);p=true}}b.push("}")}}}}}}}}}if(jstestdriver.utils.isNative(d,"object")){h.pop()}};jstestdriver.angular={};jstestdriver.angular.toJson=function(b){var a=[];jstestdriver.utils.toJsonArray(a,b,false,[]);return" ".join(a)};jstestdriver.Heartbeat=function(d,c,h,b,e,g,f,i,a){this.id_=d;this.url_=c;this.capturePath_=h;this.retries_=0;this.sendRequest_=b;this.interval_=e;this.boundHeartbeatCallback_=jstestdriver.bind(this,this.heartbeatCallback);this.boundSendHeartBeat_=jstestdriver.bind(this,this.sendHeartbeat);this.boundErrorCallback_=jstestdriver.bind(this,this.errorCallback);this.sent_=0;this.timeoutId_=-1;this.setTimeout_=g;this.getTime_=f;this.view_=i;this.navigateToPath_=a};jstestdriver.Heartbeat.RETRY_LIMIT=50;jstestdriver.Heartbeat.prototype.start=function(){this.view_.updateConnected(true);this.sendHeartbeat()};jstestdriver.Heartbeat.prototype.stop=function(){jstestdriver.clearTimeout(this.timeoutId_);this.view_.updateStatus("Dead.")};jstestdriver.Heartbeat.prototype.sendHeartbeat=function(){this.sent_=this.getTime_();this.view_.updateLastBeat(this.sent_);this.sendRequest_(this.url_,{id:this.id_},this.boundHeartbeatCallback_,this.boundErrorCallback_)};jstestdriver.Heartbeat.prototype.errorCallback=function(){this.view_.updateConnected(false);if(this.retries_>jstestdriver.Heartbeat.RETRY_LIMIT){this.stop();return}this.retries_++;this.view_.updateStatus("Retrying "+this.retries_+" out of "+jstestdriver.Heartbeat.RETRY_LIMIT);this.timeoutId_=this.setTimeout_(this.boundSendHeartBeat_,this.interval_)};jstestdriver.Heartbeat.prototype.heartbeatCallback=function(c){if(c=="UNKNOWN"){this.navigateToPath_(this.capturePath_);return}var a=this.getTime_()-this.sent_;this.sent_=0;this.view_.updateStatus(c);if(a<this.interval_){var b=this.interval_-(a>0?a:0);this.view_.updateNextBeat(b);this.timeoutId_=this.setTimeout_(this.boundSendHeartBeat_,b)}else{this.sendHeartbeat()}};jstestdriver.HeartbeatView=function(a,b){this.getBody_=a;this.createElement_=b;this.root_=null;this.status_=null;this.lastBeat_=null;this.nextBeat_=null};jstestdriver.HeartbeatView.prototype.ensureView=function(){if(!this.root_){var b=this.getBody_();var a=b.ownerDocument;this.root_=b.appendChild(a.createElement("p"));this.root_.innerHTML="JsTestDriver<br/>";this.lastBeat_=this.root_.appendChild(a.createElement("span"));this.root_.appendChild(a.createTextNode(" | "));this.nextBeat_=this.root_.appendChild(a.createElement("span"));this.root_.appendChild(a.createTextNode(" | "));this.status_=this.root_.appendChild(a.createElement("span"))}};jstestdriver.HeartbeatView.prototype.updateLastBeat=function(a){this.ensureView();this.lastBeat_.innerHTML=" Last:"+a};jstestdriver.HeartbeatView.prototype.updateNextBeat=function(a){this.ensureView();this.nextBeat_.innerHTML=" Next:"+a};jstestdriver.HeartbeatView.prototype.updateStatus=function(a){this.ensureView();this.status_.innerHTML=" Server:"+a};jstestdriver.HeartbeatView.prototype.updateConnected=function(a){if(!a){this.getBody_().className=jstestdriver.HeartbeatView.ERROR_CLASS;this.updateStatus("Lost server...")}else{this.getBody_().className="";this.updateStatus("Waiting...")}};jstestdriver.HeartbeatView.ERROR_CLASS="error";jstestdriver.createHeartbeat=function(h){function g(){return document.getElementsByTagName("body")[0]}function d(j){return document.createElement(j)}var i=new jstestdriver.HeartbeatView(g,d);function a(k,l,m,j){jstestdriver.jQuery.ajax({type:"POST",url:k,data:l,success:m,error:j,dataType:"text"})}function e(){return new Date().getTime()}function b(j){top.location=j}var c=jstestdriver.extractId(window.location.toString());var f=jstestdriver.createPath(window.location.toString(),jstestdriver.HEARTBEAT_URL);return new jstestdriver.Heartbeat(c,f,h,a,2000,jstestdriver.setTimeout,e,i,b)};